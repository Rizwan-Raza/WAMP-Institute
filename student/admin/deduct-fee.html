<?php if (!isset($_SESSION)) {
    session_start();
}
if (
    isset($_SESSION['admin']) and
    $_SESSION['admin'] == true
) {
    ?>
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Digital Marketing Company | Web Design Company</title>
    <base href="../" />
    <?php include "includes/head.inc.php"; ?>
    <link rel="stylesheet" href="admin/css/deduct.css" />
    <style>
        #canvasSimple {
            /* background-image: -webkit-linear-gradient(-135deg, white, #EEE);
            background-image: -moz-linear-gradient(-135deg, white, #EEE);
            background-image: -o-linear-gradient(-135deg, white, #EEE);
            background-image: linear-gradient(-135deg, white, #EEE);
            border: 1px solid rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 75px rgba(0, 0, 0, 0.5); */
            /* border: 1px solid rgba(0, 0, 0, 0.5); */
            position: absolute;
            bottom: 0px;
            right: 0;
            user-select: none;

        }

        .tools {
            background-color: #eee;
            height: 86px;
            overflow-y: hidden;
            padding: 1rem;
        }

        .modal.full {
            top: 0 !important;
            max-height: 100%;
        }

        .sizePanel div,
        .colorPanel div {
            float: left;
            border-radius: 28px;
        }

        .colors {
            width: 392px;
        }

        .sizes,
        .sizes * .colors,
        .colors * {
            overflow-y: hidden;
            transition: all 300ms ease;
            opacity: 1;
        }

        .sizes.shrink,
        .sizes.shrink *,
        .colors.shrink,
        .colors.shrink * {
            border: 0 !important;
            width: 0px !important;
            opacity: 0;
        }

        .sizes .sizeHolder {
            height: 56px;
            width: 56px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
        }

        .colors .colorHolder {
            height: 56px;
            width: 56px;
            border: 4px solid transparent;
        }

        .sizes .sizeHolder.active,
        .colors .colorHolder.active {
            border: 4px solid #263a73;
        }

        .sizes .sizeHolder div {
            background-color: #000;
        }

        .colors .colorHolder div {
            height: 48px;
            width: 48px;
            border: 4px solid white;
        }

        .sizes .sizeHolder:nth-child(1) div {
            height: 1px;
            width: 1px;
        }

        .sizes .sizeHolder:nth-child(2) div {
            height: 5px;
            width: 5px;
        }

        .sizes .sizeHolder:nth-child(3) div {
            height: 10px;
            width: 10px;
        }

        .sizes .sizeHolder:nth-child(4) div {
            height: 15px;
            width: 15px;
        }

        .sizes .sizeHolder:nth-child(5) div {
            height: 20px;
            width: 20px;
        }

        .sizes .sizeHolder:nth-child(6) div {
            height: 30px;
            width: 30px;
        }

        .sizes .sizeHolder:nth-child(7) div {
            height: 40px;
            width: 40px;
        }

        .colors .colorHolder:nth-child(1) div {
            background-color: #000;
        }

        .colors .colorHolder:nth-child(2) div {
            background-color: #f00;
        }

        .colors .colorHolder:nth-child(3) div {
            background-color: #0f0;
        }

        .colors .colorHolder:nth-child(4) div {
            background-color: #00f;
        }

        .colors .colorHolder:nth-child(5) div {
            background-color: #ff0;
        }

        .colors .colorHolder:nth-child(6) div {
            background-color: #0ff;
        }

        .colors .colorHolder:nth-child(7) div {
            background-color: #fff;
        }
    </style>
</head>

<body>
    <!-- Page Layout here -->
    <section class="row m-0 p-0">
        <?php include "includes/sidenav.inc.html" ?>

        <div class="col s12 m9 white m-0 p-0" style="height:100vh;overflow:auto">
            <a class="p-2 pb-0 left" href="javascript:toggleNav()"><i class="material-icons">menu</i></a>
            <div class="px-4">
                <h4 class="my-1">Deduct Fee</h4>
            </div>
            <div class="border-top-1 grey-border border-lighten-2 mt-2"></div>
            <div class="grey lighten-4">
                <div class="container pt-2">
                    <div class="card pos-rel" id="deductFee">
                        <div class="progress-holder hide border-radius-0">
                            <div class="progress border-radius-0">
                                <div class="indeterminate bg-primary"></div>
                            </div>
                        </div>
                        <div class="prevent-overlay hide full"></div>

                        <form id="deductFeeForm" class="p-4">
                            <table class="border-0">
                                <tr>
                                    <td>Student: </td>
                                    <td class="input-field">
                                        <select required name="stud_id" class="validate" id="studId">
                                            <option value="" disabled selected>Choose Student</option>
                                            <?php $sql = "SELECT * FROM `students`";
                                            require "../services/db.inc.php";
                                            $conn = DB::getConnection();
                                            $result = $conn->query($sql); 
                                            while($user = $result->fetch_assoc()) { ?>
                                            <option value="<?= $user['_sid'] ?>"><?=$user['name']?></option>
                                            <?php } ?>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Amount: </td>
                                    <td class="input-field">
                                        <input id="ddf_amount" type="number" class="validate" name="amount"
                                            placeholder="Enter Amount">
                                    </td>
                                </tr>
                                <tr>
                                    <td>Signature: &nbsp; </td>
                                    <td>
                                        <button class="btn bg-primary my-2 modal-trigger"
                                            data-target="signatureModal">Draw signature <i
                                                class="material-icons right">launch</i></button>
                                    </td>
                                </tr>
                            </table>
                            <button type="submit"
                                class="btn bg-primary white-text right mt-4 waves-effect waves-light modal-trigger scale-transition">Deduct</button>
                            <br clear="all" />
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal Structure -->
    <div id="signatureModal" class="modal full">
        <div class="tools">
            <div><button class="right mr-2 modal-close waves-effect waves-light btn-floating bg-primary"><i
                        class="material-icons">close</i></button><button id="clearCanvasSimple"
                    class="right mr-2 waves-effect waves-light btn-floating bg-primary"><i
                        class="material-icons">clear_all</i></button><button id="redoCanvas"
                    class="right mr-2 waves-effect waves-light btn-floating bg-primary"><i
                        class="material-icons">redo</i></button><button id="undoCanvas"
                    class="right mr-2 waves-effect waves-light btn-floating bg-primary"><i
                        class="material-icons">undo</i></button></div>
            <div class="sizePanel">
                <div>
                    <button class="btn-floating btn-large bg-primary waves-effect waves-light"
                        onclick="toggleSizePanel()"><i class="material-icons">edit</i></button>
                </div>
                <div class="sizes z-depth-2 white shrink">
                    <div class="sizeHolder">
                        <div data-size="1" class="size"></div>
                    </div>
                    <div class="sizeHolder">
                        <div data-size="5" class="size"></div>
                    </div>
                    <div class="sizeHolder active">
                        <div data-size="10" class="size"></div>
                    </div>
                    <div class="sizeHolder">
                        <div data-size="15" class="size"></div>
                    </div>
                    <div class="sizeHolder">
                        <div data-size="20" class="size"></div>
                    </div>
                    <div class="sizeHolder">
                        <div data-size="30" class="size"></div>
                    </div>
                    <div class="sizeHolder">
                        <div data-size="40" class="size"></div>
                    </div>

                </div>
            </div>
            <div class="colorPanel">
                <div>
                    <button class="btn-floating btn-large bg-primary waves-effect waves-light"
                        onclick="toggleColorPanel()"><i class="material-icons">palette</i></button>
                </div>
                <div class="colors z-depth-2 white shrink">
                    <div class="colorHolder">
                        <div data-color="#000000" class="color"></div>
                    </div>
                    <div class="colorHolder">
                        <div data-color="#ff0000" class="color"></div>
                    </div>
                    <div class="colorHolder active">
                        <div data-color="#00ff00" class="color"></div>
                    </div>
                    <div class="colorHolder">
                        <div data-color="#0000ff" class="color"></div>
                    </div>
                    <div class="colorHolder">
                        <div data-color="#ffff00" class="color"></div>
                    </div>
                    <div class="colorHolder">
                        <div data-color="#00ffff" class="color"></div>
                    </div>
                    <div class="colorHolder">
                        <div data-color="#ffffff" class="color"></div>
                    </div>

                </div>
            </div>
        </div>
        <div id="canvasSimpleDiv"></div>
    </div>

    <?php include "includes/scripts.inc.php"; ?>
    <script src="admin/js/queries.js"></script>
    <script>
        function getParam(parameterName) {
            var result = null,
                tmp = [];
            var items = location.search.substr(1).split("&");
            for (var index = 0; index < items.length; index++) {
                tmp = items[index].split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
            }
            return result;
        }
        if (getParam("sid")) {
            $("#deductFeeForm #studId option").removeAttr("selected");
            $("#deductFeeForm #studId option[value='" + getParam("sid") + "']").attr("selected", "selected");
            $("#deductFeeForm #studId input").val($("#deductFeeForm #studId option[value='" + getParam("sid") + "']").text());
        }
        /////////////////////////////////////////////////////


        /****************************************************************************** Simple Canvas */

        var clickX_simple = new Array();
        var clickY_simple = new Array();
        var clickDrag_simple = new Array();

        var redoX_points = new Array();
        var redoY_points = new Array();
        var redo_drag = new Array();

        var paint_simple;
        var canvas_simple;
        var context_simple;
        var canvasWidth = window.innerWidth, canvasHeight = window.innerHeight - 86;
        var strokeWidth = 10;
        /**
        * Creates a canvas element.
        */
        function prepareSimpleCanvas() {
            // Create the canvas (Neccessary for IE because it doesn't know what a canvas element is)
            var canvasDiv = document.getElementById('canvasSimpleDiv');
            canvas_simple = document.createElement('canvas');
            canvas_simple.setAttribute('width', canvasWidth);
            canvas_simple.setAttribute('height', canvasHeight);
            canvas_simple.setAttribute('id', 'canvasSimple');
            canvasDiv.appendChild(canvas_simple);
            if (typeof G_vmlCanvasManager != 'undefined') {
                canvas_simple = G_vmlCanvasManager.initElement(canvas_simple);
            }
            context_simple = canvas_simple.getContext("2d");

            // Add mouse events
            // ----------------
            $('#canvasSimple').mousedown(function (e) {
                // Mouse down location
                var mouseX = e.pageX - this.offsetLeft;
                var mouseY = e.pageY - this.offsetTop;

                paint_simple = true;
                addClickSimple(mouseX, mouseY, false);
                redrawSimple();
            });

            $('#canvasSimple').mousemove(function (e) {
                if (paint_simple) {
                    addClickSimple(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
                    redrawSimple();
                }
            });

            $('#canvasSimple').mouseup(function (e) {
                paint_simple = false;
                redrawSimple();
            });

            $('#canvasSimple').mouseleave(function (e) {
                paint_simple = false;
            });

            $('#clearCanvasSimple').mousedown(function (e) {
                clickX_simple = new Array();
                clickY_simple = new Array();
                clickDrag_simple = new Array();
                clearCanvas_simple();
            });

            // Add touch event listeners to canvas element
            canvas_simple.addEventListener("touchstart", function (e) {
                // Mouse down location
                var mouseX = (e.changedTouches ? e.changedTouches[0].pageX : e.pageX) - this.offsetLeft,
                    mouseY = (e.changedTouches ? e.changedTouches[0].pageY : e.pageY) - this.offsetTop;

                paint_simple = true;
                addClickSimple(mouseX, mouseY, false);
                redrawSimple();
            }, false);
            canvas_simple.addEventListener("touchmove", function (e) {

                var mouseX = (e.changedTouches ? e.changedTouches[0].pageX : e.pageX) - this.offsetLeft,
                    mouseY = (e.changedTouches ? e.changedTouches[0].pageY : e.pageY) - this.offsetTop;

                if (paint_simple) {
                    addClickSimple(mouseX, mouseY, true);
                    redrawSimple();
                }
                e.preventDefault()
            }, false);
            canvas_simple.addEventListener("touchend", function (e) {
                paint_simple = false;
                redrawSimple();
            }, false);
            canvas_simple.addEventListener("touchcancel", function (e) {
                paint_simple = false;
            }, false);
        }

        function addClickSimple(x, y, dragging) {
            clickX_simple.push(x);
            clickY_simple.push(y);
            clickDrag_simple.push(dragging);
        }

        function clearCanvas_simple() {
            context_simple.clearRect(0, 0, canvasWidth, canvasHeight);
        }

        function redrawSimple() {
            clearCanvas_simple();

            context_simple.strokeStyle = "#df4b26";
            context_simple.lineJoin = "round";
            context_simple.lineWidth = strokeWidth;

            for (var i = 0; i < clickX_simple.length; i++) {
                context_simple.beginPath();
                if (clickDrag_simple[i] && i) {
                    context_simple.moveTo(clickX_simple[i - 1], clickY_simple[i - 1]);
                } else {
                    context_simple.moveTo(clickX_simple[i] - 1, clickY_simple[i]);
                }
                context_simple.lineTo(clickX_simple[i], clickY_simple[i]);
                context_simple.closePath();
                context_simple.stroke();
            }
        }

        $('#undoCanvas').click(function () {
            let remIndex = clickDrag_simple.lastIndexOf(false);

            redoX_points = [...redoX_points, ...clickX_simple.slice(remIndex)];
            redoY_points = [...redoY_points, ...clickY_simple.slice(remIndex)];
            redo_drag = [...redo_drag, ...clickDrag_simple.slice(remIndex)];

            clickDrag_simple = clickDrag_simple.slice(0, remIndex);
            clickX_simple = clickX_simple.slice(0, remIndex);
            clickY_simple = clickY_simple.slice(0, remIndex);
            redrawSimple();
        });

        $('#redoCanvas').click(function () {
            let remIndex = redo_drag.lastIndexOf(false);
            clickDrag_simple = [...clickDrag_simple, ...redo_drag.slice(remIndex)];
            clickX_simple = [...clickX_simple, ...redoX_points.slice(remIndex)];
            clickY_simple = [...clickY_simple, ...redoY_points.slice(remIndex)];

            redo_drag = redo_drag.slice(0, remIndex);
            redoX_points = redoX_points.slice(0, remIndex);
            redoY_points = redoY_points.slice(0, remIndex);
            redrawSimple();
        });

        $('.sizeHolder').click(function (e) {
            var elem;
            if ($(e.target).hasClass("size")) {
                elem = $(e.target);
            } else {
                elem = $(e.target).find(".size");
            }
            elem.parent().siblings().removeClass("active");
            elem.parent().addClass("active");
            strokeWidth = elem.data("size");
        });

        function toggleSizePanel() {
            $(".sizes").toggleClass("shrink");
            $(".colors").addClass("shrink");
        }
        function toggleColorPanel() {
            $(".colors").toggleClass("shrink");
            $(".sizes").addClass("shrink");
        }

        //////////////////////////////////////////////////////////////////////////////////
        // Defining variables
        // var first = 1,
        //     canvas = document.getElementById("canvas"),
        //     ctx = canvas.getContext("2d"),
        //     isMouseDown = false,
        //     allInputs = document.querySelectorAll("input[type='text']");

        // // Canvas size
        // canvas.width = window.innerWidth - 48;
        // canvas.height = window.innerHeight - 150;

        // // Events in canvas
        // canvas.addEventListener("mousedown", drawTrue, false);
        // canvas.addEventListener("click", function () { return false; }, false);
        // canvas.addEventListener("mouseup", drawFalse, false);
        // canvas.addEventListener("mouseout", drawFalse, false);
        // canvas.addEventListener("mousemove", draw, false);

        // // Change input value
        // // If key up or key right >> input value +1
        // // If key down or key left >> input value -1
        // for (i = 0; i < allInputs.length; i++) {
        //     allInputs[i].addEventListener("keydown", function (ev) {
        //         ev = ev || window.event;
        //         // Check if value is number
        //         if (!isNaN(this.value)) {
        //             // Read keyCode from event and when it's arrow up or right, value will increment
        //             if (ev.keyCode == "38" || ev.keyCode == "39") {
        //                 ++this.value;
        //             }
        //             // If event keyCode will be from arrow down or left, value will decrement
        //             else if (ev.keyCode == "40" || ev.keyCode == "37") {
        //                 // Check if value isn't zero. If is value stay same.
        //                 if (this.value !== 0) {
        //                     --this.value;
        //                 }
        //             }
        //         }
        //         // If value isn't number
        //         else {
        //             return false;
        //         }
        //     }, false);
        // }

        // // Declaring more event listeners
        // document.getElementById("button_clear").addEventListener("click", clear, false);
        // document.getElementById("size_range").addEventListener("change", sizeSelectRange, false);
        // document.getElementById("size_text").addEventListener("keyup", sizeSelectText, false);

        // // Function that select brush size
        // function sizeSelectRange() {
        //     document.getElementById("size_text").value = document.getElementById("size_range").value;
        //     Brush.size = document.getElementById("size_text").value;
        // }

        // // Function that select brush size if it's changed by text input
        // function sizeSelectText() {
        //     document.getElementById("size_range").value = parseInt(document.getElementById("size_text").value, 10);
        //     Brush.size = document.getElementById("size_text").value;
        // }

        // // This function return selected color
        // function colorSelect() {
        //     colors = document.getElementsByName("colors");
        //     for (i = 0; i < colors.length; i++) {
        //         colors[i].addEventListener("click", function () {
        //             Brush.color = this.style.background;
        //             document.getElementById("type_of_option").style.background = this.style.background;
        //         }, false);
        //     }
        // }

        // // Defning object Brush
        // Brush = {
        //     size: 10,
        //     color: colorSelect()
        // };

        // // Defining object BrushType
        // BrushType = {
        //     // Normal Brush
        //     normalBefore: function () {
        //         // Drawing line
        //         // Defining color of line    
        //         ctx.strokeStyle = Brush.color;
        //         ctx.beginPath();
        //         // Defining size of brush
        //         ctx.lineWidth = Brush.size;
        //         // Start point of line
        //         ctx.moveTo(x, y);
        //         // Lines ending >> lines will be rounded on ends
        //         ctx.lineCap = 'round';
        //     },
        //     normalAfter: function () {
        //         // End point of line
        //         ctx.lineTo(x, y);
        //         // Draw line
        //         ctx.stroke();
        //     }
        // };

        // // Clearing of canvas
        // function clear() {
        //     canvas.width = canvas.width;
        // }

        // // Check if mouse is down
        // function drawTrue() {
        //     isMouseDown = true;
        // }

        // // Check if mouse is down
        // function drawFalse() {
        //     first = 1;
        //     isMouseDown = false;
        // }

        // // Function of drawing
        // function draw(ev) {
        //     // Check if mouse is down or not
        //     if (isMouseDown) {
        //         if (first == 1) {
        //             // Return mouse X position to var x
        //             x = ev.clientX - canvas.offsetLeft;
        //             // Return mouse Y position to var y
        //             y = ev.clientY - canvas.offsetTop;
        //             first = 0;
        //         }
        //         else if (first === 0) {
        //             // Calling of brush function
        //             BrushType.normalBefore();
        //             x = ev.clientX - canvas.offsetLeft;
        //             y = ev.clientY - canvas.offsetTop;
        //             // Calling of other brush function
        //             BrushType.normalAfter();
        //         }
        //     }
        // }

        prepareSimpleCanvas();
    </script>
</body>

</html>

<?php
} else {
    header("Location: /admin/?redirect_to=" . $_SERVER['REDIRECT_URL']);
} ?>